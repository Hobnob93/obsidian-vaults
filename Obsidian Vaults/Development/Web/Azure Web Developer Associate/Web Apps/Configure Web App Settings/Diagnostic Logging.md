#az-204 #azure #logging #csharp

# Diagnostic Logging
## Enable Diagnostic Logging
Built-in diagnostics can help with debugging an app.
The table below shows the types of logging and their specific details.

| Type                   | Platform       | Location            |
| ---------------------- | -------------- | ------------------- |
| Application Logging    | Windows, Linux | File system / blobs |
| Web server Logging     | Windows        | File system / blobs |
| Detailed error Logging | Windows        | File system         |
| Failed Request Tracing | Windows        | File system         |
| Deployment Logging     | Windows, Linux | File system         |

Here are some more details on the types of logging:
- `Application Logging`
	- Logs messages generated by app code
	- Each message assigned `Critical`, `Error`, `Warning`, `Info`, `Debug`, or `Trace`
- `Web server logging`
	- Raw HTTP data in W3C extended log file format
	- Each message includes HTTP data such as method, resource URI, client IP, port, user agent, response code, etc.
- `Detailed error logging`
	- Copies `.htm` error pages that are sent to client
	- Detailed error pages **should not** be sent to clients in production for security reasons
	- *App Service* can save the error each time one has an error code of `400` or higher
- `Failed request tracing`
	- A trace of IIS components used to process the request
	- The time taken in each IIS component
	- One folder generated per failed request, which contains:
		- XML log file
		- XSL stylesheet for viewing log file
- `Deployment logging`
	- Helps determine why deployment failed
	- Happens automatically
	- No configurable settings

## Enable Application Logging (Windows)
1. Navigate to app in *Azure Portal* and select `App Service logs`
2. Select `On` for either ==Application Logging (Filesystem)== or ==Application Logging (Blob)==, or both
	- The ==filesystem== option is temp only and turns off automatically after 12 hours!
	- The ==blob== option is for long term logging and needs a [[Azure Blob Storage|blob storage]] container to write to
3. Can select `Level` of detail included in log as per table below

| Level       | Included Categories                          |
| ----------- | -------------------------------------------- |
| Disabled    | None                                         |
| Error       | Error, Critical                              |
| Warning     | Warning, Error, Critical                     |
| Information | Info, Warning, Error, Critical               |
| Verbose     | Trace, Debug, Info, Warning, Error, Critical |

4. When finished, make sure to `Save`!

## Enable Application Logging (Linux/Container)
1. In `App Service logs` set the `Application logging` option to ==filesystem==
2. In `Quota (MB)` specify disk quota for app logs
3. In `Retention Period (Days)` set number of days logs should be retained
4. When done, click `Save`!

## Add Log Messages in Code
==ASP.NET== apps can use `System.Diagnostics.Trace` class to log information to app diagnostics logs, e.g.:
```c#
System.Diagnostics.Trace.TraceError("If you're seeeing this, something bad happened!");
```

By default, ==ASP.NET Core== uses the `Microsoft.Extensions.Logging.AzureAppService` logging provider.

## Stream Logs
Can stream logs in real time after selecting log type you want.
Any info written to files ending in `.txt`, `.log`, or `.htm` that are stored in `/LogFiles` directory is streamed by *App Service*.

To stream logs in portal, navigate to app and select `Log stream`.

To stream logs live in Cloud Shell, use the command:
```shell
az webapp log tail --name <appname> --resource-group <myResourceGroup>
```

To stream logs to local console, install *Azure CLI* and sign in.
Once signed in, you can follow the instructions for CLI above.

## Access Log Files
If you use ==blobs== for log type, you need a client tool that works with *Azure Storage*.

For ==filesystem==, the easiest way is to download a ZIP file:
- **Linux/Container apps:**
  `https://<appname>.scm.azurewebsites.net/api/logs/docker/zip`
- **Windows apps:** 
  `https://<appname>.scm.azurewebsites.net/api/dump`

For Linux/Container apps, the ZIP file contains console output logs for both docker host and docket container.
For a scaled-out app, ZIP contains one set of logs for each instance.
In *App Service* file system, these log files are contained in `/home/LogFiles`.